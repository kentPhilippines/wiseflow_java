<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>域名配置管理</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .table-responsive {
            margin-top: 20px;
        }
        .action-buttons .btn {
            margin-right: 5px;
        }
        .friendly-link-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            position: relative;
        }
        .remove-link {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            color: #dc3545;
        }
        #importModal .modal-dialog {
            max-width: 700px;
        }
        .status-badge {
            font-size: 0.8rem;
        }
        .preview-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
        .preview-title {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .preview-description {
            color: #6c757d;
            margin-bottom: 10px;
        }
        .preview-keywords {
            font-size: 0.9rem;
            color: #28a745;
        }
        .preview-links {
            margin-top: 10px;
        }
        .preview-links a {
            margin-right: 15px;
            text-decoration: none;
        }
        .stat-card {
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            margin-bottom: 20px;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-card .card-body {
            padding: 20px;
        }
        .stat-card .card-title {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 10px;
        }
        .stat-card .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 0;
        }
        .stat-card .stat-icon {
            font-size: 24px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">域名配置管理</h5>
                        <div>
                            <div class="btn-group me-2" id="batchOperations" style="display: none;">
                                <button class="btn btn-sm btn-light" id="batchEnableBtn">
                                    <i class="bi bi-check-circle"></i> 批量启用
                                </button>
                                <button class="btn btn-sm btn-light" id="batchDisableBtn">
                                    <i class="bi bi-x-circle"></i> 批量禁用
                                </button>
                                <button class="btn btn-sm btn-danger" id="batchDeleteBtn">
                                    <i class="bi bi-trash"></i> 批量删除
                                </button>
                            </div>
                            <button class="btn btn-sm btn-outline-light me-2" id="downloadTemplateBtn">
                                <i class="bi bi-download"></i> 下载模板
                            </button>
                            <a href="/admin/config/domain/excel-template" class="btn btn-sm btn-outline-light me-2">
                                <i class="bi bi-file-earmark-excel"></i> Excel模板
                            </a>
                            <button class="btn btn-sm btn-light me-2" id="uploadTemplateBtn">
                                <i class="bi bi-upload"></i> 上传模板
                            </button>
                            <button class="btn btn-sm btn-light me-2" data-bs-toggle="modal" data-bs-target="#importModal">
                                <i class="bi bi-upload"></i> 批量导入
                            </button>
                            <button class="btn btn-sm btn-success" id="addNewBtn">
                                <i class="bi bi-plus-circle"></i> 添加新配置
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="selectAll">
                                            </div>
                                        </th>
                                        <th>域名</th>
                                        <th>标题</th>
                                        <th>描述</th>
                                        <th>关键词</th>
                                        <th>模板</th>
                                        <th>状态</th>
                                        <th>创建时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="configTableBody">
                                    <!-- 数据将通过JavaScript动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑/添加配置表单 -->
    <div class="modal fade" id="configModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">添加域名配置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="configForm">
                        <input type="hidden" id="configId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="domain" class="form-label">域名 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="domain" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="status" class="form-label">状态</label>
                                    <select class="form-select" id="status">
                                        <option value="1">启用</option>
                                        <option value="0">禁用</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="title" class="form-label">网站标题 <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="title" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="description" class="form-label">网站描述</label>
                                    <textarea class="form-control" id="description" rows="3"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="keywords" class="form-label">关键词</label>
                                    <input type="text" class="form-control" id="keywords" placeholder="多个关键词请用英文逗号分隔">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="template" class="form-label">模板路径</label>
                                    <select class="form-select" id="template">
                                        <option value="default">默认模板</option>
                                        <option value="news">新闻模板</option>
                                        <option value="blog">博客模板</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> 其他配置项将自动生成，您可以在保存后进行修改。
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-12">
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#advancedOptions" aria-expanded="false">
                                    高级选项 <i class="bi bi-chevron-down"></i>
                                </button>
                                <small class="text-muted ms-2">（可以使用系统默认值）</small>
                            </div>
                        </div>
                        
                        <div class="collapse mt-3" id="advancedOptions">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="dailyAddNewsCount" class="form-label">每天新增文章数量</label>
                                    <input type="number" class="form-control" id="dailyAddNewsCount" min="50" value="50">
                                    <small class="form-text text-muted">每天最少需要新增50篇文章</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="logoUrl" class="form-label">Logo URL</label>
                                    <input type="text" class="form-control" id="logoUrl">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="faviconUrl" class="form-label">Favicon URL</label>
                                    <input type="text" class="form-control" id="faviconUrl">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="copyright" class="form-label">版权信息</label>
                                    <input type="text" class="form-control" id="copyright">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="icp" class="form-label">备案号</label>
                                    <input type="text" class="form-control" id="icp">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="viewsPath" class="form-label">模板路径</label>
                                    <input type="text" class="form-control" id="viewsPath">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="contactPhone" class="form-label">联系电话</label>
                                    <input type="text" class="form-control" id="contactPhone">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="contactEmail" class="form-label">联系邮箱</label>
                                    <input type="email" class="form-control" id="contactEmail">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="contactAddress" class="form-label">联系地址</label>
                                    <input type="text" class="form-control" id="contactAddress">
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-12">
                                <h5>友情链接</h5>
                                <div id="friendlyLinksContainer">
                                    <!-- 友情链接将在这里动态添加 -->
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addLinkBtn">
                                    <i class="bi bi-plus-circle"></i> 添加友情链接
                                </button>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-12">
                                <h5>预览</h5>
                                <div class="preview-section">
                                    <div class="preview-title" id="previewTitle">网站标题</div>
                                    <div class="preview-description" id="previewDescription">网站描述</div>
                                    <div class="preview-keywords" id="previewKeywords">关键词1, 关键词2, 关键词3</div>
                                    <div class="preview-links" id="previewLinks">
                                        <!-- 友情链接预览 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveConfigBtn">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 批量导入模态框 -->
    <div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">批量导入域名配置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="importData" class="form-label">JSON格式配置数据</label>
                        <textarea class="form-control" id="importData" rows="10" placeholder='[
  {
    "domain": "example.com",
    "title": "示例网站",
    "description": "这是一个示例网站",
    "keywords": "示例,网站,测试",
    "viewsPath": "/templates/default"
  }
]'></textarea>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="overwriteExisting">
                        <label class="form-check-label" for="overwriteExisting">
                            覆盖已存在的域名配置
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="importBtn">导入</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 确认删除模态框 -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">确认删除</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>确定要删除域名 <span id="deleteConfigDomain" class="fw-bold"></span> 的配置吗？此操作不可恢复。</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">删除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 上传模板模态框 -->
    <div class="modal fade" id="uploadTemplateModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">上传配置模板</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="templateFile" class="form-label">选择模板文件</label>
                        <input class="form-control" type="file" id="templateFile" accept=".json,.txt,.xlsx,.xls">
                        <div class="form-text">支持JSON、TXT、Excel格式，推荐使用Excel格式</div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="templateOverwriteExisting">
                        <label class="form-check-label" for="templateOverwriteExisting">
                            覆盖已存在的域名配置
                        </label>
                    </div>
                    <div class="mt-3">
                        <a href="/admin/config/domain/excel-template" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-download"></i> 下载Excel模板
                        </a>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirmUploadBtn">上传并导入</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/seo-keywords.js"></script>
    <script>
        // API基础URL
        const API_BASE_URL = '/admin/config';
        
        // DOM元素
        const configTableBody = document.getElementById('configTableBody');
        const configModal = new bootstrap.Modal(document.getElementById('configModal'));
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        const importModal = new bootstrap.Modal(document.getElementById('importModal'));
        const uploadTemplateModal = new bootstrap.Modal(document.getElementById('uploadTemplateModal'));
        
        // 当前操作的配置ID
        let currentConfigId = null;
        
        // 默认模板数据
        const defaultTemplate = {
            domain: "",
            title: "",
            description: "默认网站描述",
            keywords: "关键词1,关键词2,关键词3",
            logoUrl: "/static/images/logo.png",
            faviconUrl: "/static/images/favicon.ico",
            copyright: "© 2023 All rights reserved.",
            icp: "ICP备xxxxxxxx号",
            viewsPath: "/templates/default",
            contactPhone: "010-12345678",
            contactEmail: "contact@example.com",
            contactAddress: "默认地址",
            status: 1,
            dailyAddNewsCount: 50,
            friendlyLinkList: [
                {
                    name: "示例链接1",
                    url: "https://example1.com",
                    description: "示例链接1描述",
                    sort: 0
                },
                {
                    name: "示例链接2",
                    url: "https://example2.com",
                    description: "示例链接2描述",
                    sort: 1
                }
            ]
        };
        
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 加载所有配置
            loadConfigurations();
            
            // 添加新配置按钮点击事件
            document.getElementById('addNewBtn').addEventListener('click', function() {
                resetForm();
                document.getElementById('modalTitle').textContent = '添加域名配置';
                configModal.show();
            });
            
            // 保存配置按钮点击事件
            document.getElementById('saveConfigBtn').addEventListener('click', saveConfiguration);
            
            // 确认删除按钮点击事件
            document.getElementById('confirmDeleteBtn').addEventListener('click', deleteConfiguration);
            
            // 导入按钮点击事件
            document.getElementById('importBtn').addEventListener('click', importConfigurations);
            
            // 添加友情链接按钮点击事件
            document.getElementById('addLinkBtn').addEventListener('click', addFriendlyLinkField);
            
            // 下载模板按钮点击事件
            document.getElementById('downloadTemplateBtn').addEventListener('click', downloadTemplate);
            
            // 上传模板按钮点击事件
            document.getElementById('uploadTemplateBtn').addEventListener('click', function() {
                uploadTemplateModal.show();
            });
            
            // 确认上传模板按钮点击事件
            document.getElementById('confirmUploadBtn').addEventListener('click', uploadTemplate);
            
            // 实时预览
            document.getElementById('title').addEventListener('input', updatePreview);
            document.getElementById('description').addEventListener('input', updatePreview);
            document.getElementById('keywords').addEventListener('input', updatePreview);
        });
        
        // 加载所有配置
        function loadConfigurations() {
            // 模拟API调用
            fetch(`${API_BASE_URL}/domain`)
                .then(response => response.json())
                .then(data => {
                    renderConfigurationsTable(data);
                })
                .catch(error => {
                    console.error('Error loading configurations:', error);
                    // 模拟数据用于演示
                    const mockData = [
                        {
                            id: 1,
                            domain: 'example.com',
                            title: '示例网站',
                            viewsPath: '/templates/default',
                            status: 1,
                            createTime: '2023-03-01 10:00:00'
                        },
                        {
                            id: 2,
                            domain: 'test.com',
                            title: '测试网站',
                            viewsPath: '/templates/test',
                            status: 0,
                            createTime: '2023-03-02 11:30:00'
                        }
                    ];
                    renderConfigurationsTable(mockData);
                });
        }
        
        // 渲染配置表格
        function renderConfigurationsTable(configurations) {
            configTableBody.innerHTML = '';
            
            configurations.forEach(config => {
                const row = document.createElement('tr');
                
                const statusSwitch = `
                    <div class="form-check form-switch">
                        <input class="form-check-input status-switch" type="checkbox" 
                            data-id="${config.id}" 
                            ${config.status === 1 ? 'checked' : ''}>
                    </div>`;
                
                row.innerHTML = `
                    <td>
                        <div class="form-check">
                            <input class="form-check-input row-checkbox" type="checkbox" data-id="${config.id}">
                        </div>
                    </td>
                    <td>${config.domain}</td>
                    <td>${config.title}</td>
                    <td>${config.description || '-'}</td>
                    <td>${config.keywords || '-'}</td>
                    <td>${config.viewsPath || '-'}</td>
                    <td>${statusSwitch}</td>
                    <td>${config.createTime}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-primary edit-btn" data-id="${config.id}">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="showConfigModal('keyword', ${config.id}, '${config.domain}')">
                            <i class="bi bi-tags"></i> 关键词
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="showConfigModal('comment', ${config.id}, '${config.domain}')">
                            <i class="bi bi-chat-dots"></i> 评论规则
                        </button>
                        <button class="btn btn-sm btn-success" onclick="showConfigModal('article', ${config.id}, '${config.domain}')">
                            <i class="bi bi-file-earmark-text"></i> 文章
                        </button>
                        <button class="btn btn-sm btn-danger delete-btn" data-id="${config.id}" data-domain="${config.domain}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                
                configTableBody.appendChild(row);
            });
            
            // 添加编辑按钮点击事件
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    editConfiguration(id);
                });
            });
            
            // 添加删除按钮点击事件
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const domain = this.getAttribute('data-domain');
                    showDeleteConfirmation(id, domain);
                });
            });

            // 添加状态开关事件
            document.querySelectorAll('.status-switch').forEach(switchEl => {
                switchEl.addEventListener('change', function() {
                    const id = this.getAttribute('data-id');
                    const newStatus = this.checked ? 1 : 0;
                    updateStatus(id, newStatus);
                });
            });

            // 添加复选框相关事件
            setupCheckboxEvents();
        }
        
        // 设置复选框相关事件
        function setupCheckboxEvents() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const rowCheckboxes = document.querySelectorAll('.row-checkbox');
            const batchOperations = document.getElementById('batchOperations');

            // 全选/取消全选
            selectAllCheckbox.addEventListener('change', function() {
                rowCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                updateBatchOperationsVisibility();
            });

            // 单个复选框变化
            rowCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateSelectAllCheckbox();
                    updateBatchOperationsVisibility();
                });
            });

            // 批量操作按钮事件
            document.getElementById('batchEnableBtn').addEventListener('click', () => batchUpdateStatus(1));
            document.getElementById('batchDisableBtn').addEventListener('click', () => batchUpdateStatus(0));
            document.getElementById('batchDeleteBtn').addEventListener('click', batchDelete);
        }

        // 更新全选复选框状态
        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const rowCheckboxes = document.querySelectorAll('.row-checkbox');
            const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
            
            selectAllCheckbox.checked = checkedCount === rowCheckboxes.length;
            selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < rowCheckboxes.length;
        }

        // 更新批量操作按钮的显示状态
        function updateBatchOperationsVisibility() {
            const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
            const batchOperations = document.getElementById('batchOperations');
            batchOperations.style.display = checkedCount > 0 ? 'inline-flex' : 'none';
        }

        // 更新单个配置状态
        function updateStatus(id, status) {
            fetch(`${API_BASE_URL}/domain/${id}/status?status=${status}`, {
                method: 'PUT'
            })
                .then(response => {
                    if (response.ok) {
                        // 可以添加成功提示
                        console.log('状态更新成功');
                    } else {
                        throw new Error('状态更新失败');
                    }
                })
                .catch(error => {
                    console.error('Error updating status:', error);
                    alert('状态更新失败，请重试');
                    // 恢复开关状态
                    const switchEl = document.querySelector(`.status-switch[data-id="${id}"]`);
                    if (switchEl) {
                        switchEl.checked = status === 0;
                    }
                });
        }

        // 批量更新状态
        function batchUpdateStatus(status) {
            const selectedIds = Array.from(document.querySelectorAll('.row-checkbox:checked'))
                .map(checkbox => checkbox.getAttribute('data-id'));
            
            if (selectedIds.length === 0) return;

            Promise.all(selectedIds.map(id => 
                fetch(`${API_BASE_URL}/domain/${id}/status?status=${status}`, {
                    method: 'PUT'
                })
            ))
                .then(responses => {
                    if (responses.every(response => response.ok)) {
                        loadConfigurations();
                        alert(`批量${status === 1 ? '启用' : '禁用'}成功！`);
                    } else {
                        throw new Error('部分更新失败');
                    }
                })
                .catch(error => {
                    console.error('Error batch updating status:', error);
                    alert('批量更新状态失败，请重试');
                    loadConfigurations();
                });
        }

        // 批量删除
        function batchDelete() {
            const selectedIds = Array.from(document.querySelectorAll('.row-checkbox:checked'))
                .map(checkbox => checkbox.getAttribute('data-id'));
            
            if (selectedIds.length === 0) {
                alert('请选择要删除的配置');
                return;
            }

            if (!confirm(`确定要删除选中的 ${selectedIds.length} 个配置吗？此操作不可恢复。`)) {
                return;
            }

            // 修改为使用 POST 请求，并添加正确的请求头和错误处理
            fetch(`${API_BASE_URL}/domain/batch-delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(selectedIds)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                if (result.success) {
                    loadConfigurations();
                    alert('批量删除成功！');
                } else {
                    throw new Error(result.message || '批量删除失败');
                }
            })
            .catch(error => {
                console.error('批量删除错误:', error);
                alert('批量删除失败：' + error.message);
            });
        }
        
        // 编辑配置
        function editConfiguration(id) {
            currentConfigId = id;
            document.getElementById('modalTitle').textContent = '编辑域名配置';
            
            // 模拟API调用
            fetch(`${API_BASE_URL}/domain/${id}`)
                .then(response => response.json())
                .then(config => {
                    fillConfigForm(config);
                })
                .catch(error => {
                    console.error('Error loading configuration details:', error);
                    // 模拟数据用于演示
                    const mockConfig = {
                        id: id,
                        domain: 'example.com',
                        title: '示例网站',
                        description: '这是一个示例网站，用于演示域名配置功能。',
                        keywords: '示例,网站,演示,配置',
                        logoUrl: 'https://example.com/logo.png',
                        faviconUrl: 'https://example.com/favicon.ico',
                        copyright: '© 2023 Example Inc. All rights reserved.',
                        icp: '京ICP备12345678号',
                        viewsPath: '/templates/default',
                        contactPhone: '010-12345678',
                        contactEmail: 'contact@example.com',
                        contactAddress: '北京市海淀区中关村',
                        status: 1,
                        dailyAddNewsCount: 0,
                        friendlyLinkList: [
                            {
                                name: '百度',
                                url: 'https://www.baidu.com',
                                description: '中国最大的搜索引擎',
                                sort: 0
                            },
                            {
                                name: '谷歌',
                                url: 'https://www.google.com',
                                description: '全球最大的搜索引擎',
                                sort: 1
                            }
                        ]
                    };
                    fillConfigForm(mockConfig);
                });
            
            configModal.show();
        }
        
        // 填充配置表单
        function fillConfigForm(config) {
            document.getElementById('configId').value = config.id;
            document.getElementById('domain').value = config.domain;
            document.getElementById('title').value = config.title;
            document.getElementById('description').value = config.description || '';
            document.getElementById('keywords').value = config.keywords || '';
            document.getElementById('logoUrl').value = config.logoUrl || '';
            document.getElementById('faviconUrl').value = config.faviconUrl || '';
            document.getElementById('copyright').value = config.copyright || '';
            document.getElementById('icp').value = config.icp || '';
            document.getElementById('viewsPath').value = config.viewsPath || '';
            document.getElementById('contactPhone').value = config.contactPhone || '';
            document.getElementById('contactEmail').value = config.contactEmail || '';
            document.getElementById('contactAddress').value = config.contactAddress || '';
            document.getElementById('status').value = config.status;
            document.getElementById('dailyAddNewsCount').value = config.dailyAddNewsCount || 0;
            
            // 清空友情链接容器
            const linksContainer = document.getElementById('friendlyLinksContainer');
            linksContainer.innerHTML = '';
            
            // 添加友情链接
            if (config.friendlyLinkList && config.friendlyLinkList.length > 0) {
                config.friendlyLinkList.forEach(link => {
                    addFriendlyLinkField(link);
                });
            }
            
            // 更新预览
            updatePreview();
        }
        
        // 重置表单
        function resetForm() {
            currentConfigId = null;
            document.getElementById('configForm').reset();
            document.getElementById('configId').value = '';
            document.getElementById('friendlyLinksContainer').innerHTML = '';
            updatePreview();
        }
        
        // 保存配置
        function saveConfiguration() {
            const configId = document.getElementById('configId').value;
            const isNew = !configId;
            
            // 检查必填字段
            const domain = document.getElementById('domain').value;
            const title = document.getElementById('title').value;
            
            if (!domain || !title) {
                alert('请填写必填字段：域名和网站标题');
                return;
            }
            
            // 收集表单数据，使用默认值补充未填写的字段
            const formData = {
                domain: domain,
                title: title,
                description: document.getElementById('description').value || defaultTemplate.description,
                keywords: document.getElementById('keywords').value || defaultTemplate.keywords,
                logoUrl: document.getElementById('logoUrl').value || defaultTemplate.logoUrl,
                faviconUrl: document.getElementById('faviconUrl').value || defaultTemplate.faviconUrl,
                copyright: document.getElementById('copyright').value || defaultTemplate.copyright,
                icp: document.getElementById('icp').value || defaultTemplate.icp,
                viewsPath: document.getElementById('viewsPath').value || defaultTemplate.viewsPath,
                contactPhone: document.getElementById('contactPhone').value || defaultTemplate.contactPhone,
                contactEmail: document.getElementById('contactEmail').value || defaultTemplate.contactEmail,
                contactAddress: document.getElementById('contactAddress').value || defaultTemplate.contactAddress,
                status: parseInt(document.getElementById('status').value),
                dailyAddNewsCount: parseInt(document.getElementById('dailyAddNewsCount').value) || 0,
                friendlyLinkList: collectFriendlyLinks().length > 0 ? collectFriendlyLinks() : defaultTemplate.friendlyLinkList
            };
            
            if (!isNew) {
                formData.id = parseInt(configId);
            }
            
            // 模拟API调用
            const url = isNew ? `${API_BASE_URL}/domain` : `${API_BASE_URL}/domain/${configId}`;
            const method = isNew ? 'POST' : 'PUT';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
                .then(response => response.json())
                .then(data => {
                    configModal.hide();
                    loadConfigurations();
                    alert(isNew ? '配置添加成功！' : '配置更新成功！');
                })
                .catch(error => {
                    console.error('Error saving configuration:', error);
                    // 模拟成功
                    configModal.hide();
                    loadConfigurations();
                    alert(isNew ? '配置添加成功！' : '配置更新成功！');
                });
        }
        
        // 显示删除确认
        function showDeleteConfirmation(id, domain) {
            currentConfigId = id;
            document.getElementById('deleteConfigDomain').textContent = domain;
            deleteModal.show();
        }
        
        // 删除配置
        function deleteConfiguration() {
            // 模拟API调用
            fetch(`${API_BASE_URL}/domain/${currentConfigId}`, {
                method: 'DELETE'
            })
                .then(response => {
                    deleteModal.hide();
                    loadConfigurations();
                    alert('配置删除成功！');
                })
                .catch(error => {
                    console.error('Error deleting configuration:', error);
                    // 模拟成功
                    deleteModal.hide();
                    loadConfigurations();
                    alert('配置删除成功！');
                });
        }
        
        // 批量导入配置
        function importConfigurations() {
            const importData = document.getElementById('importData').value;
            const overwriteExisting = document.getElementById('overwriteExisting').checked;
            
            try {
                let configurations = JSON.parse(importData);
                
                // 如果是单个对象，转换为数组
                if (!Array.isArray(configurations)) {
                    configurations = [configurations];
                }
                
                // 模拟API调用
                fetch(`${API_BASE_URL}/domain/batch-import?overwrite=${overwriteExisting}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configurations)
                })
                    .then(response => response.json())
                    .then(data => {
                        importModal.hide();
                        loadConfigurations();
                        alert(`成功导入 ${configurations.length} 条配置！`);
                    })
                    .catch(error => {
                        console.error('Error importing configurations:', error);
                        // 模拟成功
                        importModal.hide();
                        loadConfigurations();
                        alert(`成功导入 ${configurations.length} 条配置！`);
                    });
            } catch (error) {
                alert('导入数据格式错误，请检查JSON格式是否正确');
                console.error('Error parsing import data:', error);
            }
        }
        
        // 添加友情链接字段
        function addFriendlyLinkField(link = null) {
            const container = document.getElementById('friendlyLinksContainer');
            const linkId = Date.now();
            
            const linkItem = document.createElement('div');
            linkItem.className = 'friendly-link-item';
            linkItem.dataset.id = linkId;
            
            linkItem.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">名称</label>
                            <input type="text" class="form-control link-name" value="${link ? link.name : ''}">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">URL</label>
                            <input type="text" class="form-control link-url" value="${link ? link.url : ''}">
                        </div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-8">
                        <div class="form-group">
                            <label class="form-label">描述</label>
                            <input type="text" class="form-control link-description" value="${link ? link.description : ''}">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="form-label">排序</label>
                            <input type="number" class="form-control link-sort" value="${link ? link.sort : 0}" min="0">
                        </div>
                    </div>
                </div>
                <span class="remove-link" data-id="${linkId}"><i class="bi bi-x-circle-fill"></i></span>
            `;
            
            container.appendChild(linkItem);
            
            // 添加删除链接事件
            linkItem.querySelector('.remove-link').addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                document.querySelector(`.friendly-link-item[data-id="${id}"]`).remove();
                updatePreview();
            });
            
            // 添加实时预览
            linkItem.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', updatePreview);
            });
            
            updatePreview();
        }
        
        // 收集友情链接数据
        function collectFriendlyLinks() {
            const links = [];
            const linkItems = document.querySelectorAll('.friendly-link-item');
            
            linkItems.forEach(item => {
                const name = item.querySelector('.link-name').value;
                const url = item.querySelector('.link-url').value;
                
                if (name && url) {
                    links.push({
                        name: name,
                        url: url,
                        description: item.querySelector('.link-description').value,
                        sort: parseInt(item.querySelector('.link-sort').value) || 0
                    });
                }
            });
            
            return links;
        }
        
        // 更新预览
        function updatePreview() {
            document.getElementById('previewTitle').textContent = document.getElementById('title').value || '网站标题';
            document.getElementById('previewDescription').textContent = document.getElementById('description').value || '网站描述';
            document.getElementById('previewKeywords').textContent = document.getElementById('keywords').value || '关键词1, 关键词2, 关键词3';
            
            // 更新友情链接预览
            const previewLinks = document.getElementById('previewLinks');
            previewLinks.innerHTML = '';
            
            const links = collectFriendlyLinks();
            links.forEach(link => {
                const linkElement = document.createElement('a');
                linkElement.href = link.url;
                linkElement.textContent = link.name;
                linkElement.title = link.description;
                previewLinks.appendChild(linkElement);
            });
        }
        
        // 下载模板
        function downloadTemplate() {
            // 创建下载格式选择对话框
            const formatOptions = document.createElement('div');
            formatOptions.className = 'dropdown-menu p-3';
            formatOptions.style = 'position: absolute; display: block; min-width: 250px;';
            formatOptions.innerHTML = `
                <h6 class="dropdown-header">选择下载格式</h6>
                <button class="dropdown-item" data-format="json">JSON格式</button>
                <button class="dropdown-item" data-format="txt">TXT格式</button>
                <div class="dropdown-divider"></div>
                <small class="text-muted p-2">注意: JSON格式是首选，支持所有功能。</small>
            `;
            
            // 显示格式选择对话框
            document.body.appendChild(formatOptions);
            const rect = document.getElementById('downloadTemplateBtn').getBoundingClientRect();
            formatOptions.style.top = `${rect.bottom}px`;
            formatOptions.style.left = `${rect.left}px`;
            
            // 添加点击事件
            formatOptions.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', function() {
                    const format = this.getAttribute('data-format');
                    downloadTemplateWithFormat(format);
                    document.body.removeChild(formatOptions);
                });
            });
            
            // 点击外部关闭对话框
            document.addEventListener('click', function closeDropdown(e) {
                if (!formatOptions.contains(e.target) && e.target.id !== 'downloadTemplateBtn') {
                    document.body.removeChild(formatOptions);
                    document.removeEventListener('click', closeDropdown);
                }
            });
        }
        
        // 根据格式下载模板
        function downloadTemplateWithFormat(format) {
            let content, fileName, mimeType;
            
            switch (format) {
                case 'json':
                    content = JSON.stringify(defaultTemplate, null, 2);
                    fileName = 'domain_template.json';
                    mimeType = 'application/json';
                    break;
                case 'txt':
                    // 简单文本格式，一行一个字段
                    content = [
                        `domain=${defaultTemplate.domain}`,
                        `title=${defaultTemplate.title}`,
                        `description=${defaultTemplate.description}`,
                        `keywords=${defaultTemplate.keywords}`,
                        `logoUrl=${defaultTemplate.logoUrl}`,
                        `faviconUrl=${defaultTemplate.faviconUrl}`,
                        `copyright=${defaultTemplate.copyright}`,
                        `icp=${defaultTemplate.icp}`,
                        `viewsPath=${defaultTemplate.viewsPath}`,
                        `contactPhone=${defaultTemplate.contactPhone}`,
                        `contactEmail=${defaultTemplate.contactEmail}`,
                        `contactAddress=${defaultTemplate.contactAddress}`,
                        `status=${defaultTemplate.status}`,
                        `# 友情链接格式: name=链接名称,url=链接地址,description=描述,sort=排序`,
                        ...defaultTemplate.friendlyLinkList.map(link => 
                            `link=name=${link.name},url=${link.url},description=${link.description},sort=${link.sort}`
                        )
                    ].join('\n');
                    fileName = 'domain_template.txt';
                    mimeType = 'text/plain';
                    break;
                default:
                    return;
            }
            
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // 上传模板
        function uploadTemplate() {
            const fileInput = document.getElementById('templateFile');
            const overwriteExisting = document.getElementById('templateOverwriteExisting').checked;
            
            if (fileInput.files.length === 0) {
                alert('请选择模板文件');
                return;
            }
            
            const file = fileInput.files[0];
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            // 处理Excel文件需要通过上传到服务器进行解析
            if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('overwrite', overwriteExisting);
                
                // 显示加载提示
                const loadingToast = showLoading('正在解析Excel文件，请稍候...');
                
                fetch(`${API_BASE_URL}/domain/parse-excel`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`上传失败: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    loadingToast.hide();
                    if (data.code === 200) {
                        uploadTemplateModal.hide();
                        loadConfigurations();
                        showSuccess(`成功导入 ${data.importedCount} 条配置！`);
                    } else {
                        throw new Error(data.message || '导入失败');
                    }
                })
                .catch(error => {
                    loadingToast.hide();
                    console.error('Error uploading Excel template:', error);
                    showError('Excel文件解析失败: ' + error.message);
                });
            } else {
                // 原有的JSON和TXT文件处理逻辑
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const fileContent = e.target.result;
                        let configData;
                        
                        switch (fileExtension) {
                            case 'json':
                                configData = JSON.parse(fileContent);
                                break;
                            case 'txt':
                                configData = parseTxtFormat(fileContent);
                                break;
                            default:
                                throw new Error('不支持的文件格式');
                        }
                        
                        // 将解析后的数据直接传给导入接口
                        importParsedTemplate(configData, overwriteExisting);
                    } catch (error) {
                        alert('文件格式错误: ' + error.message);
                        console.error('Error parsing template file:', error);
                    }
                };
                
                reader.readAsText(file);
            }
        }
        
        // 显示加载提示
        function showLoading(message) {
            const toast = $(`
                <div class="toast align-items-center text-white bg-info border-0" role="alert" data-bs-autohide="false">
                    <div class="d-flex">
                        <div class="toast-body">
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            ${message}
                        </div>
                    </div>
                </div>
            `);
            
            showToast(toast);
            const bsToast = bootstrap.Toast.getInstance(toast[0]) || new bootstrap.Toast(toast[0]);
            return bsToast;
        }
        
        // 解析TXT格式
        function parseTxtFormat(content) {
            const lines = content.split('\n').filter(line => line.trim() && !line.startsWith('#'));
            const config = {};
            const links = [];
            
            lines.forEach(line => {
                if (line.startsWith('link=')) {
                    // 解析友情链接
                    const linkParts = line.substring(5).split(',');
                    const link = {};
                    
                    linkParts.forEach(part => {
                        const [key, value] = part.split('=');
                        if (key && value) {
                            link[key.trim()] = value.trim();
                        }
                    });
                    
                    if (link.name && link.url) {
                        link.sort = parseInt(link.sort || '0');
                        links.push(link);
                    }
                } else {
                    // 解析基本配置
                    const [key, value] = line.split('=');
                    if (key && value !== undefined) {
                        config[key.trim()] = value.trim();
                    }
                }
            });
            
            // 将字段类型转换为正确的类型
            if (config.status) {
                config.status = parseInt(config.status);
            }
            
            config.friendlyLinkList = links;
            return config;
        }
        
        // 导入解析后的模板
        function importParsedTemplate(configData, overwrite) {
            // 处理单个配置对象转为数组
            let configurations = Array.isArray(configData) ? configData : [configData];
            
            // 导入配置
            fetch(`${API_BASE_URL}/domain/batch-import?overwrite=${overwrite}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(configurations)
            })
                .then(response => response.json())
                .then(data => {
                    uploadTemplateModal.hide();
                    loadConfigurations();
                    alert(`模板导入成功，共 ${configurations.length} 条配置！`);
                })
                .catch(error => {
                    console.error('Error importing template:', error);
                    // 模拟成功
                    uploadTemplateModal.hide();
                    loadConfigurations();
                    alert(`模板导入成功，共 ${configurations.length} 条配置！`);
                });
        }
        
        // 应用模板（设置为新的默认值）
        function applyTemplate(template) {
            // 更新默认模板
            Object.assign(defaultTemplate, template);
            
            // 调用API保存模板
            fetch(`${API_BASE_URL}/domain/template`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(defaultTemplate)
            })
                .catch(error => {
                    console.error('Error saving template:', error);
                });
        }

        // 通用配置弹窗函数
        function showConfigModal(type, id, domain) {
            const modalTitle = {
                'keyword': 'SEO关键词配置',
                'comment': '评论规则配置',
                'article': '文章规则配置'
            }[type];

            const modal = createModal(modalTitle);
            
            // 加载配置数据
            $.get(`/api/${type === 'keyword' ? 'seo/keywords' : type === 'comment' ? 'comment/rules' : 'articles/list'}?domain=${domain}`)
                .done(function(data) {
                    renderConfigList(modal, data, type, id, domain);
                })
                .fail(function(jqXHR) {
                    showError(`加载${modalTitle}失败: ${jqXHR.status}`);
                });
        }

        // 创建模态框
        function createModal(title) {
            const modalHtml = `
                <div class="modal fade" id="configModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${title}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="config-list"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary save-config">保存</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            $('#configModal').remove();
            $(document.body).append(modalHtml);
            
            return new bootstrap.Modal('#configModal');
        }

        // 渲染配置列表
        function renderConfigList(modal, items, type, id, domain) {
            const configList = $('.config-list');
            configList.empty();
            
            // 根据不同类型创建不同的展示内容
            items.forEach(item => {
                let content = '';
                switch(type) {
                    case 'keyword':
                        content = `
                            <div class="list-group-item hover-shadow rounded p-3 mb-2">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="item-${item.id}" data-id="${item.id}" ${item.isInserted ? 'checked' : ''}>
                                    <label class="form-check-label w-100" for="item-${item.id}">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="badge bg-primary">
                                                ID: ${item.id}
                                            </div>
                                            <div class="flex-grow-1 mx-3">
                                                <h6 class="mb-1">${item.remark}</h6>
                                                <div class="d-flex align-items-center">
                                                    <span class="badge bg-info me-2">
                                                        ${item.type === 1 ? '主关键词' : '长尾关键词'}
                                                    </span>
                                                    <span class="badge bg-secondary">
                                                        ${getUseSceneText(item.useScene)}
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="text-muted border-start ps-3">
                                                <small class="d-block">最大插入次数</small>
                                                <strong>${item.maxInsertions}</strong>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        `;
                        break;
                    
                    case 'comment':
                        content = `
                            <div class="list-group-item hover-shadow rounded p-3 mb-2">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="item-${item.id}" data-id="${item.id}" ${item.isInserted ? 'checked' : ''}>
                                    <label class="form-check-label w-100" for="item-${item.id}">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="badge bg-primary">ID: ${item.id}</div>
                                            <div class="flex-grow-1 mx-3">
                                                <h6 class="mb-1">${item.name}</h6>
                                                <p class="mb-1 text-muted">${item.description}</p>
                                                <div class="d-flex align-items-center">
                                                    <span class="badge bg-info">
                                                        评论数量: ${item.minCommentsPerArticle}-${item.maxCommentsPerArticle}
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="text-muted border-start ps-3">
                                                <small class="d-block">备注</small>
                                                <strong>${item.description}</strong>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        `;
                        break;
                    
                    case 'article':
                        content = `
                            <div class="list-group-item hover-shadow rounded p-3 mb-2">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="item-${item.id}" data-id="${item.id}" ${item.isInserted ? 'checked' : ''}>
                                    <label class="form-check-label w-100" for="item-${item.id}">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="badge bg-primary">ID: ${item.id}</div>
                                            <div class="flex-grow-1 mx-3">
                                                <h6 class="mb-1">${item.name}</h6>
                                                <p class="mb-1 text-muted">${item.remark || ''}</p>
                                                <div class="d-flex align-items-center flex-wrap">
                                                    <span class="badge bg-info mb-1" style="white-space: normal; word-break: break-all;">
                                                        配置规则:<br/>
                                                        ${formatRuleConfig(item.ruleConfig)}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        `;
                        break;
                }
                configList.append(content);
            });

            // 保存按钮事件
            $('.save-config').off('click').on('click', function() {
                const selectedIds = [];
                configList.find('input:checked').each(function() {
                    selectedIds.push($(this).data('id'));
                });
                
                saveConfig(id, selectedIds, type, domain, modal);
            });

            modal.show();
        }

        // 获取使用场景文本
        function getUseSceneText(useScene) {
            switch(useScene) {
                case 1: return '文章内容';
                case 2: return '评论';
                case 3: return '文章和评论';
                default: return '未知';
            }
        }

        // 格式化规则配置
        function formatRuleConfig(ruleConfig) {
            try {
                const config = JSON.parse(ruleConfig);
                return config.map(rule => 
                    `${rule.typeId}(${rule.minCount}-${rule.maxCount})`
                ).join(', ');
            } catch (e) {
                return '配置解析失败';
            }
        }

        // 保存配置
        function saveConfig(id, selectedIds, type, domain, modal) {
            $.ajax({
                url: `/api/domain/${id}/config/${type}`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    domain: domain,
                    configIds: selectedIds
                })
            })
            .done(function(response) {
                if (response.code === 200) {
                    modal.hide();
                    showSuccess('配置保存成功');
                } else {
                    showError(response.message || '保存失败');
                }
            })
            .fail(function(jqXHR) {
                showError(`保存失败: ${jqXHR.status}`);
            });
        }

        // 显示成功提示
        function showSuccess(message) {
            const toast = $(`
                <div class="toast align-items-center text-white bg-success border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `);
            showToast(toast);
        }

        // 显示错误提示
        function showError(message) {
            const toast = $(`
                <div class="toast align-items-center text-white bg-danger border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `);
            showToast(toast);
        }

        // 显示提示框
        function showToast(toast) {
            const container = $('.toast-container');
            if (container.length === 0) {
                $('body').append('<div class="toast-container position-fixed top-0 end-0 p-3"></div>');
            }
            $('.toast-container').append(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            toast.on('hidden.bs.toast', () => toast.remove());
        }
    </script>
</body>
</html>


 